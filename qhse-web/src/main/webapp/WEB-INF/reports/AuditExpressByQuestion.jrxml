<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE jasperReport PUBLIC "//JasperReports//DTD Report Design//EN" "http://jasperreports.sourceforge.net/dtds/jasperreport.dtd">
<jasperReport
		name="AuditExpressByQuestion"
		columnCount="1"
		printOrder="Vertical"
		orientation="Landscape"
		pageWidth="700"
		pageHeight="600"
		columnWidth="650"
		columnSpacing="10"
		leftMargin="5"
		rightMargin="5"
		topMargin="10"
		bottomMargin="10"
		whenNoDataType="AllSectionsNoDetail"
		whenResourceMissingType="Key">
	<property name="ireport.scriptlethandling" value="0" />
	<property name="ireport.encoding" value="UTF-8" />
	<import value="java.util.*" />
	<import value="net.sf.jasperreports.engine.*" />
	<import value="net.sf.jasperreports.engine.data.*" />


	<parameter name="auditProgrammeId" isForPrompting="false" class="java.lang.Long">
		<defaultValueExpression><![CDATA[new Long(9)]]></defaultValueExpression>
	</parameter>
	<parameter name="questionId" isForPrompting="false" class="java.lang.Long">
		<defaultValueExpression><![CDATA[new Long(102002)]]></defaultValueExpression>
	</parameter>
	<parameter name="departmentId" isForPrompting="false" class="java.lang.Long">
		<defaultValueExpression><![CDATA[new Long(111)]]></defaultValueExpression>
	</parameter>
	<parameter name="departmentName" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("DepartmentName")]]></defaultValueExpression>
	</parameter>
	<parameter name="dateFrom" isForPrompting="false" class="java.sql.Date">
		<defaultValueExpression><![CDATA[com.scannellsolutions.date.DateUtils.toDate(2008, 01, 01)]]></defaultValueExpression>
	</parameter>
	<parameter name="dateTo" isForPrompting="false" class="java.sql.Date">
		<defaultValueExpression><![CDATA[com.scannellsolutions.date.DateUtils.toDate(2009, 12, 01)]]></defaultValueExpression>
	</parameter>
	<parameter name="showEndDate" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression ><![CDATA[new String("2009, 12, 01")]]></defaultValueExpression>
	</parameter>
	<parameter name="auditProgrammeName" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression><![CDATA[("Audit Programme Name Goes Here")]]></defaultValueExpression>
	</parameter>
	<parameter name="questionName" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("Question Name Goes Here")]]></defaultValueExpression>
	</parameter>

	<parameter name="dateFromSql" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression><![CDATA[com.scannellsolutions.date.DateUtils.format($P{dateFrom}, "yyyy-MM-dd")]]></defaultValueExpression>
	</parameter>
	<parameter name="dateToSql" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression><![CDATA[com.scannellsolutions.date.DateUtils.format($P{dateTo}, "yyyy-MM-dd")]]></defaultValueExpression>
	</parameter>
	<parameter name="dateFromFormatted" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression><![CDATA[com.scannellsolutions.date.DateUtils.format($P{dateFrom})]]></defaultValueExpression>
	</parameter>
	<parameter name="dateToFormatted" isForPrompting="false" class="java.lang.String">
		<defaultValueExpression><![CDATA[com.scannellsolutions.date.DateUtils.format($P{dateTo})]]></defaultValueExpression>
	</parameter>

	<queryString><![CDATA[
SELECT q.display_name questionName, qo.name optionName, count(coalesce(qo.name, aa.value)) total, 0 priority FROM audit a
INNER JOIN audit_answer aa ON a.id=aa.audit_id AND aa.question_id=$P{questionId}
LEFT OUTER JOIN audit_answer_option ao ON aa.id=ao.answer_id
LEFT OUTER JOIN common_questions_option qo ON ao.option_id=qo.id
LEFT OUTER JOIN common_questions_question q ON aa.question_id=q.id
WHERE a.status in ('IN_PROGR','COMPLETE') AND a.programme=$P{auditProgrammeId} AND (0=$P{departmentId} OR a.department_id=$P{departmentId}) AND a.start_time >= $P{dateFromSql} AND  a.start_time <= $P{dateToSql}
GROUP BY q.display_name, qo.name
ORDER BY q.display_name, qo.name
]]></queryString>

	<field name="optionName" class="java.lang.String"/>
	<field name="total" class="java.lang.Number"/>
	<field name="priority" class="java.lang.String"/>

	<background />

	<title>
		<band height="70" isSplitAllowed="true">
			<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="false" evaluationTime="Now">
				<reportElement mode="Transparent" x="0" y="0" width="690" height="40" forecolor="#000000" backcolor="#EEEEDD" />
				<textElement textAlignment="Center" verticalAlignment="Top" lineSpacing="Single">
					<font fontName="Arial" pdfFontName="Helvetica-Bold" size="16" isBold="true" isUnderline="false" isPdfEmbedded="false" pdfEncoding="Cp1252" />
				</textElement>
			<textFieldExpression><![CDATA["Q-Pulse - " + $P{auditProgrammeName} + "\nBy " + $P{questionName} + "\nin " + $P{departmentName} + " from " + $P{dateFromFormatted} + " to " + $P{showEndDate}]]></textFieldExpression>
			</textField>

			<textField pattern="" isBlankWhenNull="false" evaluationTime="Now">
				<reportElement mode="Transparent" x="0" y="35" width="690" height="15" forecolor="#000000" backcolor="#FFFFFF">
					<printWhenExpression><![CDATA[Boolean.valueOf($F{optionName} == null)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Top" lineSpacing="Single">
					<font fontName="Arial" pdfFontName="Helvetica" size="10" isBold="true" isPdfEmbedded="false" pdfEncoding="Cp1252" />
				</textElement>
				<textFieldExpression><![CDATA[str("report.empty")]]></textFieldExpression>
			</textField>
		</band>
	</title>

	<pageHeader />
	<columnHeader />
	<detail />
	<columnFooter />
	<pageFooter />

	<summary>
		<band height="425" isSplitAllowed="true">
			<printWhenExpression><![CDATA[Boolean.valueOf($F{optionName} != null)]]></printWhenExpression>
			<crosstab>
				<reportElement
					mode="Opaque"
					x="430"
					y="0"
					width="260"
					height="425"
					forecolor="#000000"
					backcolor="#FFFFFF"
					key="crosstab"/>

				<crosstabParameter name="auditProgrammeId" class="java.lang.Long">
					<parameterValueExpression><![CDATA[$P{auditProgrammeId}]]></parameterValueExpression>
				</crosstabParameter>

				<crosstabParameter name="questionId" class="java.lang.Long">
					<parameterValueExpression><![CDATA[$P{questionId}]]></parameterValueExpression>
				</crosstabParameter>

				<crosstabDataset>
					<dataset>
						<incrementWhenExpression><![CDATA[Boolean.TRUE]]></incrementWhenExpression>
					</dataset>
				</crosstabDataset>

				<crosstabHeaderCell>
					<cellContents mode="Transparent">
						<box topBorder="None" leftBorder="None" rightBorder="None" bottomBorder="None" />
					</cellContents>
				</crosstabHeaderCell>

				<rowGroup name="FuncGroup" width="150" totalPosition="End">
					<bucket>
						<bucketExpression class="java.lang.String"><![CDATA[$F{optionName}]]></bucketExpression>
					</bucket>

					<crosstabRowHeader>
						<cellContents mode="Transparent">
							<box topBorder="Thin" leftBorder="Thin" rightBorder="None" bottomBorder="None" />
							<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="false" evaluationTime="Now">
								<reportElement mode="Transparent" x="5" y="5" width="145" height="15" key="textField"/>
								<box topBorder="None" leftBorder="None" rightBorder="None" bottomBorder="None" />
								<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
									<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
								</textElement>
								<textFieldExpression><![CDATA[$V{FuncGroup}]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabRowHeader>

					<crosstabTotalRowHeader>
						<cellContents backcolor="#FFFFFF" mode="Transparent">
							<box topBorder="Thin" leftBorder="None" rightBorder="None" bottomBorder="None"/>
							<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="false" evaluationTime="Now">
								<reportElement mode="Transparent" x="5" y="5" width="145" height="15" key="textField"/>
								<box topBorder="None" leftBorder="None" rightBorder="None" bottomBorder="None" />
								<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
									<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
								</textElement>
								<textFieldExpression><![CDATA[""]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabTotalRowHeader>
				</rowGroup>

				<columnGroup name="Priotirty" height="20" totalPosition="End" headerPosition="Center">
					<bucket>
						<bucketExpression class="java.lang.String"><![CDATA[$F{priority}]]></bucketExpression>
					</bucket>

					<crosstabColumnHeader>
						<cellContents mode="Transparent">
							<box topBorder="Thin" leftBorder="Thin" rightBorder="Thin" bottomBorder="None" />
							<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="false" evaluationTime="Now">
								<reportElement mode="Transparent" x="5" y="5" width="30" height="15" key="textField"/>
								<box topBorder="None" leftBorder="None" rightBorder="None" bottomBorder="None" />
								<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
									<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
								</textElement>
								<textFieldExpression><![CDATA["Total"]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabColumnHeader>

					<crosstabTotalColumnHeader>
						<cellContents mode="Transparent">
							<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="false" evaluationTime="Now">
								<reportElement mode="Transparent" x="5" y="5" width="25" height="15" key="textField"/>
								<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
									<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
								</textElement>
								<textFieldExpression><![CDATA[""]]></textFieldExpression>
							</textField>
						</cellContents>
					</crosstabTotalColumnHeader>
				</columnGroup>

				<measure name="PrioritySum" class="java.lang.Number" calculation="Sum">
					<measureExpression><![CDATA[$F{total}]]></measureExpression>
				</measure>

				<crosstabCell width="40" height="20">
					<cellContents mode="Transparent">
						<box topBorder="Thin" leftBorder="Thin" rightBorder="Thin" bottomBorder="None" />
						<textField isStretchWithOverflow="true" pattern="#0" isBlankWhenNull="false" evaluationTime="Now">
							<reportElement mode="Transparent" x="5" y="5" width="25" height="15" key="textField"/>
							<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
								<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
							</textElement>
							<textFieldExpression class="java.lang.Number"><![CDATA[$V{PrioritySum}]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>

				<crosstabCell width="40" height="20" columnTotalGroup="Priotirty">
					<cellContents mode="Transparent">
						<textField isStretchWithOverflow="true" pattern="#0" isBlankWhenNull="false" evaluationTime="Now">
							<reportElement mode="Transparent" x="5" y="5" width="25" height="15" key="textField"/>
							<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
								<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
							</textElement>
							<textFieldExpression><![CDATA[""]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>

				<crosstabCell width="40" height="20" rowTotalGroup="FuncGroup">
					<cellContents mode="Transparent">
						<box topBorder="Thin" leftBorder="None" rightBorder="None" bottomBorder="None"/>
						<textField isStretchWithOverflow="true" pattern="#0" isBlankWhenNull="false" evaluationTime="Now">
							<reportElement mode="Transparent" x="5" y="5" width="25" height="15" key="textField"/>
							<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
								<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
							</textElement>
							<textFieldExpression><![CDATA[""]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>

				<crosstabCell width="40" height="20" rowTotalGroup="FuncGroup" columnTotalGroup="Priotirty">
					<cellContents mode="Transparent">
						<textField isStretchWithOverflow="true" pattern="#0" isBlankWhenNull="false" evaluationTime="Now">
							<reportElement mode="Transparent" x="5" y="5" width="35" height="15" key="textField"/>
							<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single">
								<font fontName="Arial" pdfFontName="Helvetica" size="10" isPdfEmbedded="false" pdfEncoding="Cp1252" />
							</textElement>
							<textFieldExpression><![CDATA[""]]></textFieldExpression>
						</textField>
					</cellContents>
				</crosstabCell>

				<whenNoDataCell>
					<cellContents mode="Transparent">
						<box topBorder="Thin" leftBorder="Thin" rightBorder="None" bottomBorder="None" />
					</cellContents>
				</whenNoDataCell>
			</crosstab>

			<pieChart>
				<chart>
					<reportElement x="0" y="0" width="430" height="425"/>
					<chartTitle />
					<chartSubtitle />
				</chart>
				<pieDataset>
					<dataset>
						<incrementWhenExpression><![CDATA[Boolean.TRUE]]></incrementWhenExpression>
					</dataset>

					<keyExpression><![CDATA[$F{optionName}]]></keyExpression>
					<valueExpression><![CDATA[$F{total}]]></valueExpression>
					<labelExpression><![CDATA[$F{total} + ":" + $F{optionName}]]></labelExpression>
				</pieDataset>
				<piePlot>
					<plot />
				</piePlot>
			</pieChart>

		</band>
	</summary>
</jasperReport>
